<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate Tic Tac Toe</title>
    <style>
        /* Styles globaux */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        /* Animation de rebond */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: scale(1);
            }
            40% {
                transform: scale(1.2);
            }
            60% {
                transform: scale(0.9);
            }
        }

        /* animation de rebond aux symboles */
        .symbol.bounce {
            animation: bounce 0.5s;
        }

        /* Animation d'entr√©e */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes fadeInlayout {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Animation de sortie */
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        
      @keyframes zoom {
          0%, 100% {
              transform: scale(1);
          }
          50% {
              transform: scale(1.1);
          }
      }

      .zoom {
          animation: zoom 1s infinite;
      }
        /* animation d'entr√©e aux layouts */
        .lobby-view, .game-view, .rules-view {
            animation: fadeInlayout 0.3s ease-in-out;
        }

        /* animation de sortie aux layouts */
        .lobby-view.exit, .game-view.exit, .rules-view.exit {
            animation: fadeOut 0.3s ease-in-out;
        }
        /* animation d'entr√©e aux messages */
        .tooltip, .modal-content {
            animation: fadeIn 0.3s ease-in-out;
        }

        /* animation de sortie aux messages */
        .tooltip.exit, .modal-content.exit {
            animation: fadeOut 0.3s ease-in-out;
        }

        /* Transition pour le changement de th√®me */
        body, div, button, p, h1, h2, footer {
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        /* containers principaux */
        .container {
            width: 100%;
            max-width: 512px;
            margin: 0 auto;
            padding: 0 16px;
        }

        .min-h-screen {
            min-height: 100vh;
            padding: 32px 16px;
        }

        /* Light mode */
        .bg-gray-100 {
            background-color: #f3f4f6;
        }
        .bg-white {
            background-color: #ffffff;
        }
        .text-gray-900 {
            color: #111827;
        }
        .text-gray-600 {
            color: #4b5563;
        }
        .border-gray-300 {
            border-color: #d1d5db;
        }
        .bg-gray-200 {
            background-color: #e5e7eb;
        }
        .text-gray-800 {
            color: #1f2937;
        }
        .hover\:bg-gray-300:hover {
            background-color: #d1d5db;
        }
        .bg-blue-100 {
            background-color: #dbeafe;
        }
        .bg-red-200 {
            background-color: #fecaca;
        }
        .bg-blue-200 {
            background-color: #bfdbfe;
        }
        .ring-yellow-400 {
            box-shadow: 0 0 0 4px #fbbf24;
        }
        .text-gray-500 {
            color: #6b7280;
        }
        .bg-gray-100 {
            background-color: #f3f4f6;
        }

        /* Theme classes - Dark mode */
        .dark .bg-gray-900 {
            background-color: #111827;
        }
        .dark .bg-gray-800 {
            background-color: #1f2937;
        }
        .dark .text-white {
            color: #ffffff;
        }
        .dark .text-gray-300 {
            color: #d1d5db;
        }
        .dark .border-gray-700 {
            border-color: #374151;
        }
        .dark .bg-gray-700 {
            background-color: #374151;
        }
        .dark .bg-blue-900 {
            background-color: #1e3a8a;
        }
        .dark .text-gray-200 {
            color: #e5e7eb;
        }
        .dark .hover\:bg-gray-600:hover {
            background-color: #4b5563;
        }
        .dark .bg-gray-600 {
            background-color: #4b5563;
        }
        .dark .bg-red-900 {
            background-color: #7f1d1d;
        }
        .dark .ring-yellow-500 {
            box-shadow: 0 0 0 4px #f59e0b;
        }
        .dark .text-gray-400 {
            color: #9ca3af;
        }

        /* Common button styles */
        .difficulty-selector {
            margin-bottom: 16px;
            text-align: center;
        }

        .difficulty-selector label {
            margin-right: 8px;
            font-weight: bold;
        }

        .difficulty-dropdown {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background-color: #fff;
            color: #333;
            font-size: 16px;
        }

        .difficulty-dropdown:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        button {
            cursor: pointer;
            font-weight: 500;
            border: none;
            border-radius: 0.375rem;
        }

        .bg-blue-500 {
            background-color: #3b82f6;
            color: white;
        }
        .hover\:bg-blue-600:hover {
            background-color: #2563eb;
        }

        .bg-gray-500 {
            background-color: #6b7280;
            color: white;
        }
        .hover\:bg-gray-600:hover {
            background-color: #4b5563;
        }

        .bg-purple-500 {
            background-color: #8b5cf6;
            color: white;
        }
        .hover\:bg-purple-600:hover {
            background-color: #7c3aed;
        }

        .bg-green-500 {
            background-color: #10b981;
            color: white;
        }
        .hover\:bg-green-600:hover {
            background-color: #059669;
        }

       .hover\:bg-yellow-400:hover {
            background-color: #facc15;
       }
       .hover\:bg-emerald-600:hover {
           background-color: #84cc16;
       }

        /* Layout */
        .flex {
            display: flex;
        }
        .flex-col {
            flex-direction: column;
        }
        .items-center {
            align-items: center;
        }
        .justify-center {
            justify-content: center;
        }
        .justify-between {
            justify-between: space-between;
        }
        .gap-2 {
            gap: 8px;
        }
        .gap-3 {
            gap: 12px;
        }
        .gap-4 {
            gap: 16px;
        }
        .mt-4 {
            margin-top: 16px;
        }
        .mt-6 {
            margin-top: 24px;
        }
        .mt-8 {
            margin-top: 32px;
        }
        .mb-2 {
            margin-bottom: 8px;
        }
        .mb-4 {
            margin-bottom: 16px;
        }
        .mb-6 {
            margin-bottom: 24px;
        }
        .p-2 {
            padding: 8px;
        }
        .p-4 {
            padding: 16px;
        }
        .p-6 {
            padding: 24px;
        }
        .px-4 {
            padding-left: 16px;
            padding-right: 16px;
        }
        .py-2 {
            padding-top: 8px;
            padding-bottom: 8px;
        }
        .py-3 {
            padding-top: 12px;
            padding-bottom: 12px;
        }
        .pt-4 {
            padding-top: 16px;
        }
        .rounded {
            border-radius: 0.25rem;
        }
        .rounded-lg {
            border-radius: 0.5rem;
        }
        .rounded-full {
            border-radius: 9999px;
        }
        .border {
            border-width: 1px;
            border-style: solid;
        }
        .border-t {
            border-top-width: 1px;
            border-top-style: solid;
        }
        .border-2 {
            border-width: 2px;
            border-style: solid;
        }
        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .shadow-xl {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .w-full {
            width: 100%;
        }
        .max-w-sm {
            max-width: 384px;
        }
        .max-w-md {
            max-width: 448px;
        }
        .max-w-lg {
            max-width: 512px;
        }
        .space-y-4 > * + * {
            margin-top: 16px;
        }
        .flex-1 {
            flex: 1 1 0%;
        }

        /* Texte */
        .text-center {
            text-align: center;
        }
        .text-sm {
            font-size: 0.875rem;
        }
        .text-lg {
            font-size: 1.125rem;
        }
        .text-xl {
            font-size: 1.25rem;
        }
        .text-2xl {
            font-size: 1.5rem;
        }
        .text-3xl {
            font-size: 1.875rem;
        }
        .text-4xl {
            font-size: 2.25rem;
        }
        .text-5xl {
            font-size: 3rem;
        }
        .font-medium {
            font-weight: 500;
        }
        .font-semibold {
            font-weight: 600;
        }
        .font-bold {
            font-weight: 700;
        }
        .text-red-500 {
            color: #ef4444;
        }
        .text-blue-500 {
            color: #3b82f6;
        }

        .turn-text {
            color: #1f2937;
        }

        .dark .turn-text {
            color: #ffffff;
        }

        @media (max-width: 512px) {
            .game-board {
                gap: 8px;
                padding: 8px;
            }

            .cell {
                width: 28px;
                height: 28px;
                font-size: 0.95rem;
                aspect-ratio: 1 / 1;
            }

            .small-board {
                gap: 1px;
                padding: 1px;
                display: grid;
                grid-template-columns: repeat(3, 1fr);
            }

            .header-responsive {
                display: flex !important;
                justify-content: space-between;
                align-items: center;
            }

            .title-responsive {
                flex: 1;
                text-align: center;
                padding-right: 42px;
            }
        }

        @media (max-width: 360px) {
            .cell {
                aspect-ratio: 1 / 1;
                min-width: 18px;
                font-size: 0.75rem;
            }

            .game-board {
                gap: 4px;
                padding: 4px;
            }
        }

        @media (max-width: 400px) {
            .game-board {
                gap: 6px;
                padding: 6px;
            }

            .cell {
                width: auto;
                height: auto;
                aspect-ratio: 1 / 1;
                min-width: 20px;
                font-size: 0.875rem;
            }

            .small-board {
                gap: 0px;
                padding: 1px;
            }

            .button-grid {
                grid-template-columns: 1fr;
            }

            .modal-buttons {
                flex-direction: column;
            }
        }

        /* Game board styles */
        .game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            padding: 16px;
            max-width: 512px;
            margin: 0 auto;
            border-radius: 0.5rem;
            border-width: 2px;
            border-style: solid;
        }

        .small-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            border-width: 1px;
            border-style: solid;
            border-radius: 0.25rem;
            padding: 2px;
            position: relative;
            overflow: hidden;
        }

        .small-board.active {
            transform: scale(1.03);
        }

        .small-board.won-x {
            background-color: #fecaca;
        }
        .dark .small-board.won-x {
            background-color: #7f1d1d;
        }

        .small-board.won-o {
            background-color: #bfdbfe;
        }
        .dark .small-board.won-o {
            background-color: #1e3a8a;
        }

        .small-board.draw {
            opacity: 0.5;
        }

        .cell {
            box-sizing: border-box;
            overflow: hidden;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
        }

        .cell.valid {
            cursor: pointer;
        }

        .winner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.25rem;
            font-weight: bold;
        }

        @media (min-width: 768px) {
            .cell {
                width: 40px;
                height: 40px;
            }
            .grid-cols-2 {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
        }

        /* Game views */
        .game-view, .lobby-view, .rules-view {
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin: 0 auto;
        }

        /* Game info section */
        .game-info {
            margin-bottom: 24px;
            text-align: center;
        }

        .game-info-header {
            position: relative;
            margin-bottom: 16px;
            text-align: center;
        }

        .player-info {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 8px;
        }

        .player-box {
            padding: 8px 16px;
            border-radius: 0.5rem;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal-content {
            border-radius: 0.5rem;
            max-width: 384px;
            width: 100%;
            padding: 24px;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            background-color: black;
            color: white;
            padding: 8px 16px;
            border-radius: 0.25rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            opacity: 0.9;
            z-index: 50;
            display: none;
        }

        /* Utilities for positioning */
        .relative {
            position: relative;
        }

        .absolute {
            position: absolute;
        }

        .right-0 {
            right: 0;
        }

        .top-0 {
            top: 0;
        }

        /* Footer glitch√© */
        footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            color: white;
            text-align: center;
            padding: 10px 0;
            font-size: 0.875rem;
            z-index: 100;
        }

        /* Button layouts */
        .button-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        @media (min-width: 768px) {
            .button-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @keyframes blink {
            0%, 100% {
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
        }

        .thinking-dots {
            display: inline-block;
            font-size: 24px;
            margin: 10px;
        }

        .thinking-dots span {
            display: inline-block;
            opacity: 0;
            animation: blink 1.4s infinite both;
        }

        .thinking-dots span:nth-child(1) {
            animation-delay: 0.2s;
        }

        .thinking-dots span:nth-child(2) {
            animation-delay: 0.4s;
        }

        .thinking-dots span:nth-child(3) {
            animation-delay: 0.6s;
        }

        .turn-indicator {
            display: inline-block;
            min-width: 120px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app" class="min-h-screen">
        <div class="container">
        </div>

        <footer class="text-gray-500">
            Ultimate Tic Tac Toe ¬© 2025
        </footer>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <script>
        // Constants for reuse
        const INITIAL_GAME_STATE = {
           view: 'lobby',
           playerId: `player_${Math.random().toString(36).substring(2, 9)}`,
           playerSymbol: null,
           currentTurn: 'X',
           activeBoard: null,
           boardStates: Array(9).fill().map(() => Array(9).fill(null)),
           smallBoardWinners: Array(9).fill(null),
           gameWinner: null,
           tooltipMessage: '',
           tooltipVisible: false,
           gameMode: 'ai',
           playerTimes: {
               X: 60,
               O: 60
           },
           activeTimer: null,
           darkMode: false,
           difficulty: 'medium'
       };

        const WIN_PATTERNS = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8],
            [0, 3, 6], [1, 4, 7], [2, 5, 8],
            [0, 4, 8], [2, 4, 6]
        ];

        let gameState = {...INITIAL_GAME_STATE};
        let aiWorker;

        // Helper functions
        function checkWinSmallBoard(board) {
            return WIN_PATTERNS.some(([a, b, c]) =>
                board[a] && board[a] === board[b] && board[a] === board[c]
            );
        }

        function checkWinBigBoard(winners) {
            return WIN_PATTERNS.some(([a, b, c]) =>
                winners[a] && winners[a] !== 'draw' && winners[a] === winners[b] && winners[a] === winners[c]
            );
        }

        function isBoardFull(board) {
            return board.every(cell => cell !== null);
        }

        function isBigBoardFull(winners, boardStates) {
            if (winners.every(winner => winner !== null)) return true;
            return !boardStates.some((board, i) =>
                winners[i] === null && board.some(cell => cell === null)
            );
        }

        function adjustGameBoardSize() {
            const viewportWidth = window.innerWidth;
            const gameBoard = document.querySelector('.game-board');

            if (!gameBoard) return;

            if (viewportWidth < 360) {
                gameBoard.style.maxWidth = '270px';
            } else if (viewportWidth < 400) {
                gameBoard.style.maxWidth = '310px';
            } else if (viewportWidth < 500) {
                gameBoard.style.maxWidth = '390px';
            } else {
                gameBoard.style.maxWidth = '512px';
            }

            const cells = document.querySelectorAll('.cell');
            const smallBoards = document.querySelectorAll('.small-board');

            if (viewportWidth < 360) {
                smallBoards.forEach(board => {
                    board.style.gap = '0px';
                    board.style.padding = '1px';
                });
            } else if (viewportWidth < 400) {
                smallBoards.forEach(board => {
                    board.style.gap = '1px';
                    board.style.padding = '1px';
                });
            }
        }

        function postRenderAdjustments() {
            adjustGameBoardSize();
            const smallBoards = document.querySelectorAll('.small-board');
            smallBoards.forEach((board, index) => {
                if (gameState.activeBoard === index && gameState.smallBoardWinners[index] === null) {
                    const viewportWidth = window.innerWidth;
                    if (viewportWidth < 400) {
                        board.style.transform = 'scale(1.02)';
                        board.style.boxShadow = '0 0 0 2px #fbbf24';
                    }
                }
            });
            ensureSquareCells();
        }

        function ensureSquareCells() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                const width = cell.offsetWidth;
                cell.style.height = `${width}px`;
            });
        }

        function showTooltip(message) {
            gameState.tooltipMessage = message;
            gameState.tooltipVisible = true;

            const tooltip = document.getElementById('tooltip');
            tooltip.textContent = message;
            tooltip.style.display = 'block';
            tooltip.classList.remove('exit');
            tooltip.classList.add('tooltip');

            setTimeout(() => {
                gameState.tooltipVisible = false;
                tooltip.style.display = 'none';
            }, 2000);
        }

        function toggleDarkMode() {
            gameState.darkMode = !gameState.darkMode;
            document.body.classList.toggle('dark', gameState.darkMode);
            document.body.classList.toggle('bg-gray-100', !gameState.darkMode);
            document.body.classList.toggle('bg-gray-900', gameState.darkMode);

            const appDiv = document.getElementById('app');
            appDiv.classList.toggle('bg-gray-100', !gameState.darkMode);
            appDiv.classList.toggle('bg-gray-900', gameState.darkMode);

            renderView();
        }

        function startNewGame(mode = 'ai') {
            const difficultyDropdown = document.getElementById('difficulty');
            const difficulty = mode === 'timed' ? '4' : (difficultyDropdown ? difficultyDropdown.value : gameState.difficulty);
            const darkMode = gameState.darkMode;
            gameState = {...INITIAL_GAME_STATE};
            gameState.darkMode = darkMode;
            gameState.view = 'game';
            gameState.gameMode = mode;
            gameState.difficulty = difficulty;
            gameState.playerSymbol = Math.random() < 0.5 ? 'X' : 'O';

            if (mode === 'timed') {
                gameState.playerTimes = {
                    X: 60,
                    O: 60
                };
            }

            renderView();

            if (mode === 'ai' || mode === 'timed') {
                const modal = renderFirstPlayerModal();
                document.body.appendChild(modal);
            }
        }

        function showRules() {
            gameState.view = 'rules';
            renderView();
        }

        function backToLobby() {
            if (gameState.activeTimer) {
                clearInterval(gameState.activeTimer);
                gameState.activeTimer = null;
            }

            gameState.playerTimes = {
                X: 60,
                O: 60
            };

            const darkMode = gameState.darkMode;
            gameState = {...INITIAL_GAME_STATE};
            gameState.view = 'lobby';
            gameState.preventAIMove = true;
            gameState.darkMode = darkMode;

            renderView();
        }

        function startTimer(player) {
            if (gameState.activeTimer) {
                clearInterval(gameState.activeTimer);
                gameState.activeTimer = null;
            }

            gameState.activeTimer = setInterval(() => {
                if (gameState.playerTimes[player] > 0 && !gameState.gameWinner) {
                    gameState.playerTimes[player]--;
                    renderView();
                } else {
                    clearInterval(gameState.activeTimer);
                    if (!gameState.gameWinner) {
                        gameState.gameWinner = player === 'X' ? 'O' : 'X';
                    }
                    renderView();
                }
            }, 1000);
        }

        function pauseTimer() {
            if (gameState.activeTimer) {
                clearInterval(gameState.activeTimer);
                gameState.activeTimer = null;
            }
        }

        function handleSquareClick(bigIndex, smallIndex) {
            const { gameWinner, gameMode, currentTurn, playerSymbol,
                   activeBoard, smallBoardWinners, boardStates } = gameState;

            if (gameWinner) {
                showTooltip("The game is already over!");
                return;
            }

            if (activeBoard !== null && activeBoard !== bigIndex) {
                showTooltip("You must play in the indicated grid!");
                return;
            }

            if (smallBoardWinners[bigIndex] !== null) {
                showTooltip("This grid is already won!");
                return;
            }

            if (boardStates[bigIndex][smallIndex] !== null) {
                showTooltip("This cell is already taken!");
                return;
            }

            const newBoardStates = JSON.parse(JSON.stringify(boardStates));
            newBoardStates[bigIndex][smallIndex] = currentTurn;

            const newSmallBoardWinners = [...gameState.smallBoardWinners];
            if (checkWinSmallBoard(newBoardStates[bigIndex])) {
                newSmallBoardWinners[bigIndex] = currentTurn;
            } else if (isBoardFull(newBoardStates[bigIndex])) {
                newSmallBoardWinners[bigIndex] = 'draw';
            }

            let nextActiveBoard = smallIndex;
            if (newSmallBoardWinners[smallIndex] !== null) {
                nextActiveBoard = null;
            }

            let newGameWinner = null;
            if (checkWinBigBoard(newSmallBoardWinners)) {
                newGameWinner = currentTurn;
            } else if (isBigBoardFull(newSmallBoardWinners, newBoardStates)) {
                newGameWinner = 'draw';
            }

            gameState = {
                ...gameState,
                boardStates: newBoardStates,
                smallBoardWinners: newSmallBoardWinners,
                currentTurn: currentTurn === 'X' ? 'O' : 'X',
                activeBoard: nextActiveBoard,
                gameWinner: newGameWinner,
                lastMove: { bigIndex, smallIndex }
            };

            renderView();

            if (gameMode === 'timed') {
                pauseTimer();
                if (!newGameWinner) {
                    startTimer(gameState.currentTurn);
                }
            }

            if ((gameMode === 'ai' || gameMode === 'timed') && !newGameWinner && gameState.currentTurn !== playerSymbol) {
                setTimeout(() => simulateOpponentMove(), 1000);
            }
        }

        function simulateOpponentMove() {
            if (gameState.preventAIMove) {
                return;
            }
            const { activeBoard, boardStates, smallBoardWinners, currentTurn, difficulty, gameMode } = gameState;
            const opponentSymbol = currentTurn;
            const playerSymbol = opponentSymbol === 'X' ? 'O' : 'X';

            let maxDepth;
            switch (difficulty) {
                case '1':
                    maxDepth = 1;
                    break;
                case '4':
                    maxDepth = 4;
                    break;
                case '6':
                    maxDepth = 6;
                    break;
                case '9':
                    maxDepth = 9;
                    break;
                default:
                    maxDepth = 4;
            }

            const isFirstMove = boardStates.every(board => board.every(cell => cell === null));

            if (isFirstMove) {
                const validMoves = findValidMoves(activeBoard, boardStates, smallBoardWinners);
                if (validMoves.length > 0) {
                    const [bigIndex, smallIndex] = validMoves[Math.floor(Math.random() * validMoves.length)];
                    const delay = gameMode === 'timed' ? 900 : 0;
                    setTimeout(() => handleSquareClick(bigIndex, smallIndex), delay);
                    return;
                }
            }

            if (!aiWorker) {
                aiWorker = new Worker('aiWorker.js');
            }

            aiWorker.onmessage = function(e) {
                const bestMove = e.data;
                if (bestMove) {
                    const delay = gameMode === 'timed' ? 900 : 0;
                    setTimeout(() => handleSquareClick(bestMove[0], bestMove[1]), delay);
                } else {
                    const validMoves = findValidMoves(activeBoard, boardStates, smallBoardWinners);
                    if (validMoves.length > 0) {
                        const [bigIndex, smallIndex] = validMoves[Math.floor(Math.random() * validMoves.length)];
                        const delay = gameMode === 'timed' ? 900 : 0;
                        setTimeout(() => handleSquareClick(bigIndex, smallIndex), delay);
                    }
                }
            };

            aiWorker.postMessage({
                activeBoard,
                boardStates,
                smallBoardWinners,
                aiSymbol: opponentSymbol,
                playerSymbol,
                depth: maxDepth
            });
        }

        function findValidMoves(activeBoard, boardStates, smallBoardWinners) {
            const validMoves = [];

            if (activeBoard === null || smallBoardWinners[activeBoard] !== null) {
                for (let i = 0; i < 9; i++) {
                    if (smallBoardWinners[i] === null) {
                        for (let j = 0; j < 9; j++) {
                            if (boardStates[i][j] === null) {
                                validMoves.push([i, j]);
                            }
                        }
                    }
                }
            } else {
                for (let j = 0; j < 9; j++) {
                    if (boardStates[activeBoard][j] === null) {
                        validMoves.push([activeBoard, j]);
                    }
                }
            }

            return validMoves;
        }

        function renderCell(bigIndex, smallIndex) {
            const { boardStates, gameMode, playerSymbol, currentTurn,
                   activeBoard, smallBoardWinners, darkMode, lastMove } = gameState;

            const value = boardStates[bigIndex][smallIndex];
            const theme = darkMode ? 'dark' : 'light';

            let cellClass = "cell ";

            if (value === null) {
                const isInteractive = (gameMode === 'ai' || gameMode === 'timed') && playerSymbol === currentTurn || gameMode === 'local';
                const isValidTarget = (activeBoard === null || activeBoard === bigIndex) && smallBoardWinners[bigIndex] === null;

                cellClass += theme === 'dark' ? 'bg-gray-800 ' : 'bg-white ';

                if (isInteractive && isValidTarget) {
                    cellClass += theme === 'dark' ? 'hover:bg-gray-600 ' : 'hover:bg-blue-100 ';
                    cellClass += 'valid';
                }
            } else {
                cellClass += theme === 'dark' ? 'bg-gray-800 ' : 'bg-white ';
            }

            const cell = document.createElement('div');
            cell.className = cellClass;

            if (value) {
                const symbol = document.createElement('span');
                symbol.className = `symbol ${value === 'X' ? 'text-red-500 font-bold' : 'text-blue-500 font-bold'}`;
                symbol.textContent = value;

                if (lastMove && lastMove.bigIndex === bigIndex && lastMove.smallIndex === smallIndex) {
                    symbol.classList.add('bounce');
                    setTimeout(() => {
                        symbol.classList.remove('bounce');
                    }, 500);
                }

                cell.appendChild(symbol);
            }

            const columnPosition = smallIndex % 3;
            cell.dataset.column = columnPosition;
            cell.dataset.row = Math.floor(smallIndex / 3);

            if (cellClass.includes('valid')) {
                cell.addEventListener('click', () => handleSquareClick(bigIndex, smallIndex));
            }

            return cell;
        }

        function renderSmallBoard(index) {
            const { activeBoard, smallBoardWinners, darkMode } = gameState;
            const winner = smallBoardWinners[index];
            const theme = darkMode ? 'dark' : 'light';
            const viewportWidth = window.innerWidth;

            const boardDiv = document.createElement('div');
            boardDiv.className = `small-board ${theme === 'dark' ? 'border-gray-700' : 'border-gray-300'}`;

            boardDiv.style.display = 'grid';
            boardDiv.style.gridTemplateColumns = 'repeat(3, 1fr)';
            boardDiv.style.gridTemplateRows = 'repeat(3, 1fr)';

            if (activeBoard === index && winner === null) {
                boardDiv.classList.add('active');
                if (viewportWidth < 400) {
                    boardDiv.style.boxShadow = `0 0 0 2px ${theme === 'dark' ? '#f59e0b' : '#fbbf24'}`;
                } else {
                    boardDiv.style.boxShadow = `0 0 0 4px ${theme === 'dark' ? '#f59e0b' : '#fbbf24'}`;
                }
            }

            if (winner !== null) {
                if (winner === 'draw') {
                    boardDiv.classList.add('draw');
                } else {
                    boardDiv.classList.add(winner === 'X' ? 'won-x' : 'won-o');
                }
            }

            if (winner !== null && winner !== 'draw') {
                const winnerOverlay = document.createElement('div');
                winnerOverlay.className = 'winner-overlay';

                const symbol = document.createElement('span');
                symbol.className = winner === 'X' ? 'text-red-500' : 'text-blue-500';
                symbol.textContent = winner;

                winnerOverlay.appendChild(symbol);
                boardDiv.appendChild(winnerOverlay);
            } else {
                for (let i = 0; i < 9; i++) {
                    boardDiv.appendChild(renderCell(index, i));
                }
            }

            return boardDiv;
        }

        function renderGameBoard() {
            const { darkMode } = gameState;
            const theme = darkMode ? 'dark' : 'light';

            const boardContainer = document.createElement('div');
            boardContainer.className = `game-board ${theme === 'dark' ? 'bg-gray-900 border-gray-700' : 'bg-gray-100 border-gray-300'}`;

            boardContainer.style.display = 'grid';
            boardContainer.style.gridTemplateColumns = 'repeat(3, 1fr)';
            boardContainer.style.gridTemplateRows = 'repeat(3, 1fr)';

            const viewportWidth = window.innerWidth;
            if (viewportWidth < 360) {
                boardContainer.style.gap = '4px';
                boardContainer.style.padding = '4px';
            } else if (viewportWidth < 400) {
                boardContainer.style.gap = '6px';
                boardContainer.style.padding = '6px';
            } else if (viewportWidth < 512) {
                boardContainer.style.gap = '8px';
                boardContainer.style.padding = '8px';
            } else {
                boardContainer.style.gap = '16px';
                boardContainer.style.padding = '16px';
            }

            for (let i = 0; i < 9; i++) {
                boardContainer.appendChild(renderSmallBoard(i));
            }

            return boardContainer;
        }

        function renderGameInfo() {
    const { gameMode, currentTurn, playerSymbol, darkMode, playerTimes } = gameState;
    const theme = darkMode ? 'dark' : 'light';

    const infoDiv = document.createElement('div');
    infoDiv.className = `game-info ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`;

    const header = document.createElement('div');
    header.className = 'game-info-header';

    const modeTitleContainer = document.createElement('div');
    modeTitleContainer.className = 'mode-title-container';
    modeTitleContainer.style.padding = '10px';
    modeTitleContainer.style.borderRadius = '8px';
    modeTitleContainer.style.display = 'inline-block';
    modeTitleContainer.style.backgroundColor = darkMode ? '#4b5563' : '#d1d5db';

    const modeTitle = document.createElement('h2');
    modeTitle.className = 'text-3xl font-bold';
    modeTitle.textContent = gameMode === 'ai' ? 'Solo vs AI' : gameMode === 'local' ? 'Local Multiplayer' : 'Timed Mode';
    modeTitleContainer.appendChild(modeTitle);
    header.appendChild(modeTitleContainer);

    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'absolute right-0 top-0 p-2 rounded-full';
    toggleBtn.style.backgroundColor = darkMode ? '#374151' : '#e5e7eb';
    toggleBtn.style.color = darkMode ? '#e5e7eb' : '#1f2937';
    toggleBtn.textContent = darkMode ? '‚òÄÔ∏è' : 'üåô';
    toggleBtn.addEventListener('click', toggleDarkMode);
    header.appendChild(toggleBtn);

    infoDiv.appendChild(header);

    if (gameMode === 'timed') {
        const timers = document.createElement('div');
        timers.className = 'player-info';

        const timerXContainer = document.createElement('div');
        timerXContainer.className = `player-box ${currentTurn === 'X' ? (theme === 'dark' ? 'bg-blue-900 zoom' : 'bg-blue-100 zoom') : (theme === 'dark' ? 'bg-gray-700' : 'bg-gray-100')}`;
        timerXContainer.innerHTML = `<span class="text-red-500 font-bold">${playerSymbol === 'X' ? 'üë§' : 'ü§ñ'} X : ${playerTimes.X}s</span>`;

        const timerOContainer = document.createElement('div');
        timerOContainer.className = `player-box ${currentTurn === 'O' ? (theme === 'dark' ? 'bg-blue-900 zoom' : 'bg-blue-100 zoom') : (theme === 'dark' ? 'bg-gray-700' : 'bg-gray-100')}`;
        timerOContainer.innerHTML = `<span class="text-blue-500 font-bold">${playerSymbol === 'O' ? 'üë§' : 'ü§ñ'} O : ${playerTimes.O}s</span>`;

        timers.appendChild(timerXContainer);
        timers.appendChild(timerOContainer);
        infoDiv.appendChild(timers);
    } else if (gameMode === 'local') {
        const playerInfo = document.createElement('div');
        playerInfo.className = 'player-info';

        const playerX = document.createElement('div');
        playerX.className = `player-box ${currentTurn === 'X' ? (theme === 'dark' ? 'bg-blue-900 zoom' : 'bg-blue-100 zoom') : (theme === 'dark' ? 'bg-gray-700' : 'bg-gray-100')}`;
        playerX.innerHTML = `<span class="text-red-500 font-bold">X</span>${currentTurn === 'X' ? ' - Your turn' : ''}`;

        const playerO = document.createElement('div');
        playerO.className = `player-box ${currentTurn === 'O' ? (theme === 'dark' ? 'bg-blue-900 zoom' : 'bg-blue-100 zoom') : (theme === 'dark' ? 'bg-gray-700' : 'bg-gray-100')}`;
        playerO.innerHTML = `<span class="text-blue-500 font-bold">O</span>${currentTurn === 'O' ? ' - Your turn' : ''}`;

        playerInfo.appendChild(playerX);
        playerInfo.appendChild(playerO);
        infoDiv.appendChild(playerInfo);
    } else if (gameMode === 'ai') {
        const playerInfo = document.createElement('div');
        playerInfo.className = 'player-info';

        const playerSymbolElement = document.createElement('div');
        playerSymbolElement.className = `player-box ${currentTurn === playerSymbol ? (theme === 'dark' ? 'bg-blue-900 zoom' : 'bg-blue-100 zoom') : (theme === 'dark' ? 'bg-gray-700' : 'bg-gray-100')}`;
        playerSymbolElement.innerHTML = `<span class="${playerSymbol === 'X' ? 'text-red-500' : 'text-blue-500'} font-bold">${playerSymbol === 'X' ? 'üë§ X' : 'üë§ O'}</span>${currentTurn === playerSymbol ? ' - Your turn' : ''}`;

        const aiSymbolElement = document.createElement('div');
        aiSymbolElement.className = `player-box ${currentTurn !== playerSymbol ? (theme === 'dark' ? 'bg-blue-900 zoom' : 'bg-blue-100 zoom') : (theme === 'dark' ? 'bg-gray-700' : 'bg-gray-100')}`;
        aiSymbolElement.innerHTML = `<span class="${playerSymbol === 'X' ? 'text-blue-500' : 'text-red-500'} font-bold">ü§ñ ${playerSymbol === 'X' ? 'O' : 'X'}</span>${currentTurn !== playerSymbol ? ' - AI is thinking' : ''}`;

        playerInfo.appendChild(playerSymbolElement);
        playerInfo.appendChild(aiSymbolElement);
        infoDiv.appendChild(playerInfo);
    }

    const controls = document.createElement('div');
    controls.className = 'mt-6 flex justify-center gap-2';

    const newGameBtn = document.createElement('button');
    newGameBtn.className = 'bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600';
    newGameBtn.textContent = 'New Game';
    newGameBtn.addEventListener('click', () => {
        if (gameState.gameMode === 'timed') {
            pauseTimer();
        }
        startNewGame(gameState.gameMode);
    });

    const lobbyBtn = document.createElement('button');
    lobbyBtn.className = 'bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600';
    lobbyBtn.textContent = 'Back to Lobby';
    lobbyBtn.addEventListener('click', backToLobby);

    controls.appendChild(newGameBtn);
    controls.appendChild(lobbyBtn);
    infoDiv.appendChild(controls);

    return infoDiv;
}

        function renderTurnIndicator() {
    // Retourne toujours un √©l√©ment vide pour tous les modes
    return document.createElement('div');
}


        function renderGameOverModal() {
            const { gameWinner, gameMode, playerSymbol, darkMode, difficulty, playerTimes } = gameState;

            if (!gameWinner) return null;

            const theme = darkMode ? 'dark' : 'light';

            let message = "";
            let iconSymbol = "";
            let additionalInfo = "";

            const difficultyNames = {
                '1': 'Easy',
                '4': 'Normal',
                '6': 'Difficult',
                '9': 'Impossible'
            };

            const difficultyName = difficultyNames[difficulty] || 'Unknown';

            if (gameWinner === 'draw') {
                message = "The game ended in a draw.";
                iconSymbol = "ü§ù";
                additionalInfo = "Both players played well.";
            } else if (gameMode === 'ai') {
                message = gameWinner === playerSymbol ? "You won." : "AI won.";
                iconSymbol = gameWinner === playerSymbol ? "üèÜ" : "ü§ñ";
                additionalInfo = gameWinner === playerSymbol ? `You defeated the AI at level ${difficultyName}.` : `The AI won at level ${difficultyName}.`;
            } else if (gameMode === 'timed') {
                if (playerTimes.X <= 0 || playerTimes.O <= 0) {
                    message = gameWinner === 'X' ? "Player O ran out of time. Player X wins!" : "Player X ran out of time. Player O wins!";
                    iconSymbol = gameWinner === 'X' ? "‚ùå" : "‚≠ï";
                    additionalInfo = `Time's up!`;
                } else {
                    message = `Player ${gameWinner} won.`;
                    iconSymbol = gameWinner === 'X' ? "‚ùå" : "‚≠ï";
                    additionalInfo = `Player ${gameWinner} played well.`;
                }
            } else {
                message = `Player ${gameWinner} won.`;
                iconSymbol = gameWinner === 'X' ? "‚ùå" : "‚≠ï";
                additionalInfo = `Player ${gameWinner} played well.`;
            }

            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';

            const modal = document.createElement('div');
            modal.className = `modal-content ${theme === 'dark' ? 'bg-gray-800 text-white border-gray-700' : 'bg-white text-gray-900 border-gray-300'} border`;

            const header = document.createElement('div');
            header.className = 'modal-header';

            const icon = document.createElement('div');
            icon.className = 'text-5xl mb-4';
            icon.textContent = iconSymbol;

            const title = document.createElement('h2');
            title.className = 'text-2xl font-bold mb-2';
            title.textContent = message;

            const info = document.createElement('p');
            info.className = 'text-lg mb-4';
            info.textContent = additionalInfo;

            header.appendChild(icon);
            header.appendChild(title);
            header.appendChild(info);

            const buttons = document.createElement('div');
            buttons.className = window.innerWidth < 400 ? 'modal-buttons flex flex-col gap-2' : 'modal-buttons flex gap-2';

            const newGameBtn = document.createElement('button');
            newGameBtn.className = 'bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex-1';
            newGameBtn.textContent = 'New Game';
            newGameBtn.addEventListener('click', () => {
                closeMessage(overlay);
                startNewGame(gameMode);
            });

            const lobbyBtn = document.createElement('button');
            lobbyBtn.className = 'bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 flex-1';
            lobbyBtn.textContent = 'Back to Lobby';
            lobbyBtn.addEventListener('click', () => {
                closeMessage(overlay);
                backToLobby();
            });

            buttons.appendChild(newGameBtn);
            buttons.appendChild(lobbyBtn);

            modal.appendChild(header);
            modal.appendChild(buttons);
            overlay.appendChild(modal);

            return overlay;
        }

        function renderLobbyView() {
            const { darkMode } = gameState;
            const theme = darkMode ? 'dark' : 'light';

            const lobby = document.createElement('div');
            lobby.className = `lobby-view ${theme === 'dark' ? 'bg-gray-800 text-white' : 'bg-white text-gray-900'}`;

            const header = document.createElement('div');
            header.className = 'relative text-center mb-6 header-responsive';

            const title = document.createElement('h1');
            title.className = 'text-3xl font-bold title-responsive';
            title.textContent = 'Ultimate Tic Tac Toe';

            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'absolute right-0 top-0 p-2 rounded-full';
            toggleBtn.style.backgroundColor = darkMode ? '#374151' : '#e5e7eb';
            toggleBtn.style.color = darkMode ? '#e5e7eb' : '#1f2937';
            toggleBtn.textContent = darkMode ? '‚òÄÔ∏è' : 'üåô';
            toggleBtn.addEventListener('click', toggleDarkMode);

            header.appendChild(title);
            header.appendChild(toggleBtn);
            lobby.appendChild(header);

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex flex-col gap-4';

            const firstRow = document.createElement('div');
            firstRow.className = 'flex flex-col gap-4';

            const aiBtn = document.createElement('button');
            aiBtn.className = 'bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 text-lg flex items-center justify-center gap-2';
            aiBtn.innerHTML = '<span>ü§ñ</span> Play against AI';
            aiBtn.addEventListener('click', () => startNewGame('ai'));

            const difficultySelector = document.createElement('div');
            difficultySelector.className = 'difficulty-selector';

            const difficultyLabel = document.createElement('label');
            difficultyLabel.setAttribute('for', 'difficulty');
            difficultyLabel.textContent = 'Difficulty:';

            const difficultyDropdown = document.createElement('select');
            difficultyDropdown.id = 'difficulty';
            difficultyDropdown.className = 'difficulty-dropdown';

            const easyOption = document.createElement('option');
            easyOption.value = '1';
            easyOption.textContent = 'Easy';

            const mediumOption1 = document.createElement('option');
            mediumOption1.value = '4';
            mediumOption1.textContent = 'Normal';
            mediumOption1.selected = true;

            const mediumOption2 = document.createElement('option');
            mediumOption2.value = '6';
            mediumOption2.textContent = 'Difficult';

            const hardOption = document.createElement('option');
            hardOption.value = '9';
            hardOption.textContent = 'Impossible';

            difficultyDropdown.appendChild(easyOption);
            difficultyDropdown.appendChild(mediumOption1);
            difficultyDropdown.appendChild(mediumOption2);
            difficultyDropdown.appendChild(hardOption);

            difficultySelector.appendChild(difficultyLabel);
            difficultySelector.appendChild(difficultyDropdown);

            firstRow.appendChild(aiBtn);
            firstRow.appendChild(difficultySelector);

            const secondRow = document.createElement('div');
            secondRow.className = 'flex flex-col gap-4';

            const multiplayerBtn = document.createElement('button');
            multiplayerBtn.className = 'bg-purple-500 text-white px-4 py-3 rounded-lg hover:bg-purple-600 text-lg flex items-center justify-center gap-2';
            multiplayerBtn.innerHTML = '<span>üë•</span> Local Multiplayer';
            multiplayerBtn.addEventListener('click', () => startNewGame('local'));

            const timedBtn = document.createElement('button');
            timedBtn.className = 'bg-purple-500 text-white px-4 py-3 rounded-lg hover:bg-purple-600 text-lg flex items-center justify-center gap-2';
            timedBtn.innerHTML = '<span>‚è±Ô∏è</span> Timed Mode';
            timedBtn.addEventListener('click', () => startNewGame('timed'));

            secondRow.appendChild(multiplayerBtn);
            secondRow.appendChild(timedBtn);

            const rulesBtn = document.createElement('button');
            rulesBtn.className = `${theme === 'dark' ? 'bg-gray-700 text-gray-200' : 'bg-gray-200 text-gray-800'} px-4 py-2 rounded ${theme === 'dark' ? 'hover:bg-gray-600' : 'hover:bg-gray-300'} mt-4`;
            rulesBtn.textContent = 'Game Rules';
            rulesBtn.addEventListener('click', showRules);

            buttonContainer.appendChild(firstRow);
            buttonContainer.appendChild(secondRow);
            buttonContainer.appendChild(rulesBtn);
            lobby.appendChild(buttonContainer);

            difficultyDropdown.addEventListener('change', function() {
                gameState.difficulty = this.value;
                console.log('Difficulty changed to:', gameState.difficulty);
                showTooltip(`Difficulty set to: ${gameState.difficulty}`);
            });

            return lobby;
        }

        function renderRulesView() {
            const { darkMode } = gameState;
            const theme = darkMode ? 'dark' : 'light';

            const rules = [
                "Ultimate Tic Tac Toe consists of 9 small Tic Tac Toe grids, forming one large grid.",
                "On each turn, you must play in the small grid corresponding to the cell played by your opponent in their small grid.",
                "For example, if your opponent plays in the top-right cell of their small grid, you must play in the top-right small grid of the large grid.",
                "If you are sent to a grid that is already won or full, you can play in any open grid.",
                "To win a small grid, align 3 symbols as in classic Tic Tac Toe.",
                "To win the game, align 3 won small grids."
            ];

            const rulesView = document.createElement('div');
            rulesView.className = `rules-view ${theme === 'dark' ? 'bg-gray-800 text-white' : 'bg-white text-gray-900'}`;

            const header = document.createElement('div');
            header.className = 'relative mb-4';

            const title = document.createElement('h1');
            title.className = 'text-2xl font-bold text-center';
            title.textContent = 'Game Rules';

            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'p-2 rounded-full absolute right-0 top-0';
            toggleBtn.style.backgroundColor = darkMode ? '#374151' : '#e5e7eb';
            toggleBtn.style.color = darkMode ? '#e5e7eb' : '#1f2937';
            toggleBtn.textContent = darkMode ? '‚òÄÔ∏è' : 'üåô';
            toggleBtn.addEventListener('click', toggleDarkMode);

            header.appendChild(title);
            header.appendChild(toggleBtn);
            rulesView.appendChild(header);

            const rulesList = document.createElement('div');
            rulesList.className = `space-y-4 mb-6 border-t ${theme === 'dark' ? 'border-gray-700' : 'border-gray-300'} pt-4`;

            rules.forEach((rule, index) => {
                const ruleItem = document.createElement('div');
                ruleItem.className = 'flex gap-3';

                const number = document.createElement('div');
                number.className = 'text-2xl';
                number.textContent = `${index + 1}Ô∏è‚É£`;

                const text = document.createElement('p');
                text.textContent = rule;

                ruleItem.appendChild(number);
                ruleItem.appendChild(text);
                rulesList.appendChild(ruleItem);
            });

            rulesView.appendChild(rulesList);

            const backBtn = document.createElement('button');
            backBtn.className = 'bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full';
            backBtn.textContent = 'Back to Lobby';
            backBtn.addEventListener('click', backToLobby);

            rulesView.appendChild(backBtn);

            return rulesView;
        }

        function renderGameView() {
            const container = document.createElement('div');

            container.appendChild(renderGameInfo());
            container.appendChild(renderGameBoard());
            container.appendChild(renderTurnIndicator());

            const modal = renderGameOverModal();
            if (modal && !document.querySelector('.modal-overlay')) {
                container.appendChild(modal);
            }

            return container;
        }

        function renderFirstPlayerModal() {
            const { playerSymbol, darkMode } = gameState;
            const theme = darkMode ? 'dark' : 'light';

            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';

            const modal = document.createElement('div');
            modal.className = `modal-content ${theme === 'dark' ? 'bg-gray-800 text-white border-gray-700' : 'bg-white text-gray-900 border-gray-300'} border`;

            const header = document.createElement('div');
            header.className = 'modal-header';

            const icon = document.createElement('div');
            icon.className = 'text-5xl mb-4';
            icon.textContent = playerSymbol === 'X' ? '‚ùå' : '‚≠ï';

            const title = document.createElement('h2');
            title.className = 'text-2xl font-bold mb-2';
            title.textContent = `You are playing as ${playerSymbol}`;

            const info = document.createElement('p');
            info.className = 'text-lg mb-4';
            info.textContent = playerSymbol === 'X' ? 'You go first!' : 'AI goes first!';

            header.appendChild(icon);
            header.appendChild(title);
            header.appendChild(info);

            const buttons = document.createElement('div');
            buttons.className = 'modal-buttons flex gap-2';

            const continueBtn = document.createElement('button');
            continueBtn.className = 'bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex-1';
            continueBtn.textContent = 'Continue';
            continueBtn.addEventListener('click', () => {
                closeMessage(overlay);
                if (playerSymbol === 'O') {
                    setTimeout(() => simulateOpponentMove(), 1000);
                } else if (gameState.gameMode === 'timed') {
                    if (gameState.activeTimer) {
                        clearInterval(gameState.activeTimer);
                        gameState.activeTimer = null;
                    }
                    startTimer(playerSymbol);
                }
            });

            buttons.appendChild(continueBtn);
            modal.appendChild(header);
            modal.appendChild(buttons);
            overlay.appendChild(modal);

            return overlay;
        }

        function closeMessage(element) {
            element.classList.add('exit');
            setTimeout(() => {
                element.remove();
            }, 100);
        }

        function renderView() {
            const appContainer = document.querySelector('#app .container');
            appContainer.innerHTML = '';

            document.body.classList.toggle('dark', gameState.darkMode);

            switch (gameState.view) {
                case 'lobby':
                    appContainer.appendChild(renderLobbyView());
                    break;
                case 'rules':
                    appContainer.appendChild(renderRulesView());
                    break;
                case 'game':
                    appContainer.appendChild(renderGameView());
                    setTimeout(postRenderAdjustments, 0);
                    break;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderView();
            adjustGameBoardSize();

            window.addEventListener('resize', () => {
                adjustGameBoardSize();
            });
        });
    </script>
</body>
</html>
